= Digital Modernization

:imagesdir: ../../images
:icons: font

== Continuous Integration/Continuous Delivery (CI/CD)

****
*Expected Outcome:*

* 300 level understaing of Kubernetes Continuous Deployment:
** Create a source code repository using AWS CodeCommit
** Configure a CI/CD pipeline using AWS CodePipeline
** Deploy AWS CodeBuild to build your container image and push to ECS

*Lab Requirements*

* Cloud9 IDE.
* an Amazon Elastic Container Service for Kubernetes Cluster.

*Average Lab Time:*
45-60 minutes
****

=== Introduction
This moduleis designed to improve your undesrtanding of the link:https://aws.amazon.com/codestar/[AWS Code*] services like, link:https://aws.amazon.com/codecommit/[AWS CodeCommit], link:https://aws.amazon.com/codebuild/[AWS CodeBuild], link:https://aws.amazon.com/codepipeline/[AWS Codepipeline] and link:https://aws.amazon.com/lambda/[AWS Lambda] can be used for continuous deployment on link:https://aws.amazon.com/eks/[Amazon EKS].

The following *Reference Architecture* details the how the above AWS services will be leveraged and the specific steps we will follow for this module.

=== Reference Architecure
image:architecture.png[Architecture]

=== Setting up the CI/CD Pipeline

NOTE: The following section of the module assumes a working EKS cluster, created in *Module 6 - Amazon EKS*.

Step 0:: Role `CodePipelineServiceRole`
[source,json]
----
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Action": [
                "s3:*"
            ],
            "Resource": [
                "*"
            ],
            "Effect": "Allow"
        },
        {
            "Action": [
                "codecommit:GetBranch",
                "codecommit:GetCommit",
                "codecommit:UploadArchive",
                "codecommit:GetUploadArchiveStatus",
                "codecommit:CancelUploadArchive"
            ],
            "Resource": "*",
            "Effect": "Allow"
        },
        {
            "Action": [
                "codepipeline:*",
                "iam:ListRoles",
                "iam:PassRole",
                "codedeploy:CreateDeployment",
                "codedeploy:GetApplicationRevision",
                "codedeploy:GetDeployment",
                "codedeploy:GetDeploymentConfig",
                "codedeploy:RegisterApplicationRevision",
                "lambda:*",
                "sns:*"
            ],
            "Resource": "*",
            "Effect": "Allow"
        },
        {
            "Action": [
                "codebuild:StartBuild",
                "codebuild:StopBuild",
                "codebuild:BatchGet*",
                "codebuild:Get*",
                "codebuild:List*",
                "codecommit:GetBranch",
                "codecommit:GetCommit",
                "codecommit:GetRepository",
                "codecommit:ListBranches",
                "s3:GetBucketLocation",
                "s3:ListAllMyBuckets"
            ],
            "Resource": "*",
            "Effect": "Allow"
        },
        {
            "Action": [
                "logs:GetLogEvents"
            ],
            "Resource": "arn:aws:logs:*:*:log-group:/aws/codebuild/*:log-stream:*",
            "Effect": "Allow"
        }
    ]
}
----




Step 1:: Create repo

+
[source,shell]
----
aws ecr create-repository --repository-name eks-cicd-demo-repo --region us-west-2
----
+
[.output]
----
{
    "repository": {
        "registryId": "<REDACTED>", 
        "repositoryName": "eks-cicd-demo-repo", 
        "repositoryArn": "arn:aws:ecr:us-west-2:<.REDACTED>:repository/eks-cicd-demo-repo", 
        "createdAt": 1558127545.0, 
        "repositoryUri": "<REDACTED>.dkr.ecr.us-west-2.amazonaws.com/eks-cicd-demo-repo"
    }
}
----
+
step 2:: Create repo
+
[source,shell]
----
aws codecommit create-repository --repository-name eks-cicd-demo-repo --repository-description "EKS CICD demonstration repository" --region us-west-2
----
+
Expected Output:
+
[.output]
----
{
    "repositoryMetadata": {
        "repositoryName": "eks-cicd-demo-repo", 
        "cloneUrlSsh": "ssh://git-codecommit.us-west-2.amazonaws.com/v1/repos/eks-cicd-demo-repo", 
        "lastModifiedDate": 1558126857.734, 
        "repositoryDescription": "EKS CICD demonstration repository", 
        "cloneUrlHttp": "https://git-codecommit.us-west-2.amazonaws.com/v1/repos/eks-cicd-demo-repo", 
        "creationDate": 1558126857.734, 
        "repositoryId": "1d5e262b-ff0a-4555-a552-31a87db6373a", 
        "Arn": "arn:aws:codecommit:us-west-2:<REDACTED>:eks-cicd-demo-repo", 
        "accountId": "<REDACTED>"
    }
}
----
+
Step 3:: Commit to repo
+
[source,shell]
----
git config --global credential.helper '!aws codecommit credential-helper $@'

git config --global credential.UseHttpPath true

git clone https://git-codecommit.us-west-2.amazonaws.com/v1/repos/eks-cicd-demo-repo

cp aws-eks-cicd-essentials/sample-app/* eks-cicd-demo-repo/

cd eks-cicd-demo-repo

git add . && git commit -m "initial commit ofsample app" && git push origin master
----
+
Step 4:: Create pipeline
+
BLAH BLAH
+
Step 5:: Add build stage
+
BLAH BLAH BLAH
+
Step 6:: Lambda client for Kubernetes
+
[source,shell]
----
cd ..
git clone https://github.com/BranLiang/lambda-eks
cd lambda-eks

sed -i -e "s#\$EKS_CA#$(aws eks describe-cluster --name k8s-workshop --query cluster.certificateAuthority.data --output text)#g" ./config
sed -i -e "s#\$EKS_CLUSTER_HOST#$(aws eks describe-cluster --name k8s-workshop --query cluster.endpoint --output text)#g" ./config
sed -i -e "s#\$EKS_CLUSTER_NAME#k8s-workshop#g" ./config
sed -i -e "s#\$EKS_CLUSTER_USER_NAME#lambda#g" ./config
----
+
Step 7:: Check secrets
+
[source,shell]
----
kubectl get secrets
----
+
Expected Output:
+
[.output]
----
NAME                  TYPE                                  DATA      AGE
default-token-dwfwk   kubernetes.io/service-account-token   3         22m
----
+
Step 8:: Update Token
+
[source,shell]
----
sed -i -e "s#\$TOKEN#$(kubectl get secret $SECRET_NAME -o json | jq -r '.data["token"]' | base64 -d)#g" ./config
----
+
Step 9:: Build, Package, deploy
+
[source,shell]
----
npm install
zip -r lambda-package_v1.zip .
export LAMBDA_SERVICE_ROLE=$(aws cloudformation describe-stacks --stack-name $AWS_MASTER_STACK | jq -r '.Stacks[0].Outputs[]|select(.OutputKey=="LambdaExecutionRoleArn")|.OutputValue')
aws lambda create-function --function-name LambdaKubeClient --runtime nodejs8.10 --role $LAMBDA_SERVICE_ROLE --handler index.handler  --zip-file fileb://lambda-package_v1.zip --timeout 10 --memory-size 128
----
+
Step 10:: Prioviuding admin access
+
[source,shell]
----
kubectl create clusterrolebinding default-admin --clusterrole cluster-admin --serviceaccount=default:default
----
+
Step 11:: Add deployment stage
+
BLAH B:AH B:AH
+
Step 12:: Test
